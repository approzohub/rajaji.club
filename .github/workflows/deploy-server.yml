name: Deploy Server

on:
  push:
    branches: [main]
    paths: ['server/**']
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set GHCR token
        id: ghcr_token
        run: |
          if [ -n "${{ secrets.GHCR_PAT }}" ]; then
            echo "token=${{ secrets.GHCR_PAT }}" >> $GITHUB_OUTPUT
          else
            echo "token=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_OUTPUT
          fi

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: ./server
          file: ./server/.docker/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository }}/server:latest
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ steps.ghcr_token.outputs.token }}

      - name: Deploy to VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            cd /opt/rajaji-server || mkdir -p /opt/rajaji-server && cd /opt/rajaji-server
            mkdir -p .docker
            
            [ ! -f .docker/docker-compose.yml ] && cat > .docker/docker-compose.yml << EOF
            version: '3.8'
            services:
              server:
                image: ghcr.io/${{ github.repository }}/server:latest
                container_name: rajaji-server
                restart: unless-stopped
                env_file:
                  - ../.env
                volumes:
                  - ../uploads:/app/uploads
              caddy:
                image: caddy:latest
                container_name: rajaji-caddy
                restart: unless-stopped
                ports:
                  - "80:80"
                  - "443:443"
                  - "443:443/udp"
                volumes:
                  - ./Caddyfile:/etc/caddy/Caddyfile
                  - caddy_data:/data
                  - caddy_config:/config
            volumes:
              caddy_data:
              caddy_config:
            EOF
            
            [ ! -f .docker/Caddyfile ] && echo "api.rajaji.club { reverse_proxy server:4000 }" > .docker/Caddyfile
            
            sed -i "s|image: ghcr.io/.*/server:.*|image: ghcr.io/${{ github.repository }}/server:latest|" .docker/docker-compose.yml
            GHCR_TOKEN="${{ secrets.GHCR_PAT }}"
            if [ -z "$GHCR_TOKEN" ]; then
              GHCR_TOKEN="${{ secrets.GITHUB_TOKEN }}"
            fi
            echo "$GHCR_TOKEN" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker pull ghcr.io/${{ github.repository }}/server:latest
            cd .docker && docker-compose down && docker-compose up -d

